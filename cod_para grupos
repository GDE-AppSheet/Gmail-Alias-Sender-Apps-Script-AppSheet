/**
 * Gmail Alias Sender ‚Äî Utilities
 * --------------------------------
 * Utilidades simples para:
 * 1) Listar los alias de env√≠o disponibles en tu cuenta de Gmail.
 * 2) Enviar correos "desde" un alias validando primero que exista en "Enviar como".
 *
 * Requisitos:
 * - El alias debe estar configurado en Gmail > Configuraci√≥n > Cuentas e importaci√≥n > "Enviar correo como".
 * - Este script usa GmailApp (no requiere habilitar APIs avanzadas).
 *
 * Seguridad / Privacidad:
 * - No dejes correos reales ni nombres propios en el c√≥digo. Usa placeholders.
 * - Configura el nombre del remitente en la llamada (senderName) o deja que Gmail use el predeterminado.
 *
 * @author TuNombre
 * @license MIT
 */

/** Nombre remitente por defecto si no se pasa en la llamada. */
const DEFAULT_SENDER_NAME = 'Tu Equipo';

/**
 * Devuelve el listado de alias de env√≠o (las direcciones que puedes usar en "from").
 * √ötil para ver si tu alias ya est√° disponible.
 *
 * @returns {string[]} Arreglo con alias/direcciones configuradas en "Enviar como".
 */
function listAliases() {
  const aliases = GmailApp.getAliases();
  Logger.log('Aliases disponibles: %s', JSON.stringify(aliases, null, 2));
  return aliases;
}

/**
 * Indica si puedes enviar desde el alias indicado.
 *
 * @param {string} desiredFrom - Correo del alias a validar (p.ej. "alias@tu-dominio.com").
 * @returns {boolean} true si el alias est√° disponible; de lo contrario false.
 */
function canSendFrom(desiredFrom) {
  if (!desiredFrom) return false;
  const aliases = GmailApp.getAliases() || [];
  return aliases.indexOf(desiredFrom) !== -1;
}

/**
 * Env√≠a un correo validando que el alias exista en "Enviar como".
 *
 * @param {string} recipient - Destinatario (p.ej. "usuario@correo.com").
 * @param {string} subject - Asunto del mensaje.
 * @param {string} htmlBody - Cuerpo HTML del mensaje (el texto plano se env√≠a vac√≠o).
 * @param {string} desiredFrom - Alias desde el cual enviar (debe existir en "Enviar como").
 * @param {string} [senderName=DEFAULT_SENDER_NAME] - Nombre que ver√° el receptor como remitente.
 * @returns {{ok: boolean, mode: string, from: string, to: string}} Resumen del env√≠o.
 * @throws {Error} Si el alias no est√° disponible o si GmailApp falla al enviar.
 */
function sendFromAliasIfAvailable(recipient, subject, htmlBody, desiredFrom, senderName) {
  if (!recipient || !subject || !htmlBody || !desiredFrom) {
    throw new Error('Par√°metros insuficientes: recipient, subject, htmlBody y desiredFrom son obligatorios.');
  }

  if (!canSendFrom(desiredFrom)) {
    throw new Error('Alias no disponible en tu cuenta: ' + desiredFrom);
  }

  const nameToUse = senderName || DEFAULT_SENDER_NAME;

  GmailApp.sendEmail(recipient, subject, '', {
    htmlBody: htmlBody,
    from: desiredFrom,   // Debe existir en "Enviar como"
    name: nameToUse
  });

  Logger.log('Env√≠o OK desde %s hacia %s, modo: GmailApp (alias)', desiredFrom, recipient);
  return { ok: true, mode: 'GmailApp (alias)', from: desiredFrom, to: recipient };
}

/**
 * (Opcional) Prueba r√°pida de env√≠o.
 * - Reemplaza los placeholders ANTES de ejecutar.
 * - Deja comentada si no la necesitas.
 */
function __test_sendFromAlias() {
  const RECIPIENT   = 'destinatario@ejemplo.com';     // TODO: cambiar
  const SUBJECT     = 'Prueba de env√≠o con alias';
  const HTML_BODY   = '<p>Hola üëã, esto es una <strong>prueba</strong> desde alias.</p>';
  const DESIRED_FROM= 'alias@tu-dominio.com';         // TODO: cambiar (debe estar en "Enviar como")
  const SENDER_NAME = 'Tu Equipo de Pruebas';         // Opcional

  try {
    const result = sendFromAliasIfAvailable(RECIPIENT, SUBJECT, HTML_BODY, DESIRED_FROM, SENDER_NAME);
    Logger.log(JSON.stringify(result));
  } catch (err) {
    Logger.log('Error en __test_sendFromAlias: %s', err && err.message ? err.message : err);
    throw err;
  }
}
